#!/bin/sh
PREREQ=""
prereqs() { echo "$PREREQ"; }
case $1 in
  prereqs) prereqs; exit 0;;
esac

# Detect plymouth rotation parameter from kernel command line
# Image theme uses plymouth=, text theme uses rotate=
PLYMOUTH_ROTATION=0
TEXT_ROTATION=0

if grep -q "plymouth=90" /proc/cmdline 2>/dev/null; then PLYMOUTH_ROTATION=90; fi
if grep -q "plymouth=180" /proc/cmdline 2>/dev/null; then PLYMOUTH_ROTATION=180; fi
if grep -q "plymouth=270" /proc/cmdline 2>/dev/null; then PLYMOUTH_ROTATION=270; fi

if grep -q "rotate=90" /proc/cmdline 2>/dev/null; then TEXT_ROTATION=90; fi
if grep -q "rotate=180" /proc/cmdline 2>/dev/null; then TEXT_ROTATION=180; fi
if grep -q "rotate=270" /proc/cmdline 2>/dev/null; then TEXT_ROTATION=270; fi

# Patch image theme (volumio-adaptive) - uses plymouth_rotation variable
ADAPTIVE_SCRIPT="/usr/share/plymouth/themes/volumio-adaptive/volumio-adaptive.script"
if [ -f "$ADAPTIVE_SCRIPT" ]; then
  sed -i "s/^plymouth_rotation = [0-9]*;/plymouth_rotation = ${PLYMOUTH_ROTATION};/" "$ADAPTIVE_SCRIPT"
fi

# Patch text theme (volumio-text) - uses global.rotation variable
TEXT_SCRIPT="/usr/share/plymouth/themes/volumio-text/volumio-text.script"
if [ -f "$TEXT_SCRIPT" ]; then
  sed -i "s/^global\.rotation = [0-9]*;/global.rotation = ${TEXT_ROTATION};/" "$TEXT_SCRIPT"
fi

